---
title: "Assignment 3 - Dynamic Linear Models (Part I)"
output: pdf_document
date: "2023-04-24"
header-includes:
   - \usepackage{floatrow}
   - \floatsetup[figure]{capposition=top}
   - \floatplacement{figure}{H}
---


```{r setup, echo=F, message=F, warning = F}
knitr::opts_chunk$set(message = FALSE,
                      results = FALSE,
                      warning = FALSE,
                      echo = FALSE,
                      fig.align = "center")

set.seed(2020)
#libraries
library(depmixS4)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)
library(ggrepel)
library(tidyverse)
library(ggplot2)
library(data.table)
library(gt)
library(dlm)
library(dplyr)
theme_set(theme_bw())
```

Group members:
---

* Barni Martina (3118929)

* Figlino Guerino (3111009)

* Noce Alberto (3225732)

* Ungarelli Flavia (3092154)


Data and model
---

We consider the data on the annual flow of the river Nile at Ashwan between 1871 and 1970, plotted in Figure \ref{fig:fig1}.

```{r fig1, fig.cap = "Annual flow of the river Nile (1871 - 1970)", out.width = '70%', fig.align = "center", echo = FALSE}
plot(Nile, ylab = "Nile annual flow")
```

We observe that the time series is non-stationary but presents an evident change point around 1898. Therefore, we use a *local level* model to capture the main change point and other minor changes. We consider the following random walk plus noise model:

\begin{eqnarray*} 
&y_t = \theta_t + v_t \quad    & v_t \sim N(0,V)\\
&\theta_t = \theta_{t-1} + w_t \quad   & w_t \sim N(0, W)
\end{eqnarray*}

with the assumption that $\theta_{0} \perp (v_{t}) \perp (w_{t})$. We assume that $V=\sigma^2_v=15100$ and $W=\sigma^2_w=1470$.
Let $\theta_0 \sim N(1000, 1000)$ be the initial distribution.


Question 1
---

We compute and plot (Figure \ref{fig:fig2}) the filtering states estimates $m_t=E(\theta_t|y_{1:t})$, for **t**=1,2,...,T.

``` {r, include = FALSE}
model <- dlm(m0 = 1000, C0 = 1000, FF = 1, V = 15100, GG = 1, W = 1470)
outputFilter <- dlmFilter(Nile, model)
filterEstimates = window(outputFilter$m,start=start(Nile)[1])
```

```{r, fig2, fig.cap = "Nile river data and filtering states estimates", out.width = '70%', fig.align = "center", echo = FALSE}
plot(Nile, y = NULL, ylab = "Nile annual flow", plot.type = "multiple", type = "o", cex = 0.3)
lines(filterEstimates, col="red", type="o",lty=2, pch=4, cex = 0.3)
legend("bottomright",legend=c("data","filtered level"), col = c("black", "red"), lty=c(1,2), pch=c(1,4))
```


We also compute and plot (Figure \ref{fig:fig3}) the corresponding standard deviations:
$$\sqrt{C_t}= V(\theta_t|y_{1:t})^{1/2}$$
``` {r, fig3, fig.cap = "Filetring states Standard Deviations", out.width = '70%', fig.align = "center", echo = FALSE}
n <- length(Nile)
Ct <- dlmSvd2var(outputFilter$U.C, outputFilter$D.C)
sqrtCt <- sqrt(unlist(Ct))
sqrtCt_ts <- ts(sqrtCt[-1], start = 1871, end = 1970, frequency = 1)
ts.plot(sqrtCt_ts, xlab = "Time", ylab = "Standard deviation")
```

We find that the standard deviation does not converge to zero but rather to approximately 63.5.

\newpage
We plot the data together with the filtering state estimates and their 0.95 credible intervals (Figure \ref{fig:fig4}).

``` {r, fig4, fig.cap = "Nile data and filter estimates with credible intervals", out.width = '70%', fig.align = "center", echo = FALSE}
ci95_low <- outputFilter$m + qnorm((1-0.95)/2) * sqrtCt
ci95_up <- outputFilter$m - qnorm((1-0.95)/2) * sqrtCt
par(mar = c(4, 4, 4, 4) + 0.1, cex = 0.8)
plot(Nile, type = "o", cex = 0.3, col="black", ylab = "Nile annual flow")
lines(filterEstimates, type="o",lty=2, pch=4, cex = 0.3, col="red")
lines(ci95_low, lty = "longdash", col="blue")
lines(ci95_up, lty = "longdash", col="blue")
legend("bottomright",legend=c("data","filtered level","95% c.i."),
     col=c("black", "red","blue"),lty=c(1,2,2),pch=c(1,4,20))
```


Question 2
---

We compute the one-step ahead forecasts: $f_t=E(Y_t|y_{1:t-1}), \; t=1,...,T$ and plot the data, together with the one-step ahead forecasts and their 0.95 credible intervals (Figure \ref{fig:fig5}).

``` {r, fig5, fig.cap = "Nile river data and one-step ahead forecasts", out.width = '70%', fig.align = "center", echo = FALSE}
listR <- dlmSvd2var(outputFilter$U.R, outputFilter$D.R)
sqrtQ <- sqrt(unlist(listR)+15100)
ci95_lowf <- outputFilter$f + qnorm((1-0.95)/2)* sqrtQ
ci95_upf <- outputFilter$f - qnorm((1-0.95)/2) * sqrtQ
par(mar = c(4, 4, 4, 4) + 0.1, cex = 0.8)
plot(window(Nile, start=start(Nile)), y = NULL, plot.type = "multiple", ylab = "Nile annual flow", type = "o", cex = 0.3)
lines(window(outputFilter$f, start=start(Nile)), col = "red", type="o",lty=2, pch=4, cex = 0.3)
lines(ci95_lowf, lty = "longdash", col="blue")
lines(ci95_upf, lty = "longdash", col="blue")
legend("bottomright",legend=c("data","one-step ahead forecast", "95% c.i."), col = c("black", "red", "blue"), lty=c(1,2,2), pch=c(1,4,20))
```


Question 3
---

The signal-to-noise ratio (i.e. the ratio $\sigma^2_w/\sigma^2_v$) affects the forecasts, as it represents the weight given to observed data in the filtering step.

We repeat the excercise with different choices of V (observation variance) and W (evolution variance). 

We can use the following command to experiment with different values:

V <- sample(1:20000, 1)

W <- sample(1:20000, 1)

```{r include=FALSE}
V <- sample(1:20000, 1)
W <- sample(1:20000, 1)
```

To report our findings, we show an example in which we exchange the two variances and assume the model to be:

\begin{eqnarray*} 
&y_t = \theta_t + v_t \quad    & v_t \sim N(0,V)\\
&\theta_t = \theta_{t-1} + w_t \quad   & w_t \sim N(0, W)
\end{eqnarray*}
where V = 1470 and W = 15100.

The signal-to-noise ratio of the model 1 was $\sigma^2_w/\sigma^2_v$ = 1470/15100 = 0.097. The signal-to-noise ratio of the model 2 is $\sigma^2_w/\sigma^2_v = 15100/1470 = 10.272$, way larger than before.

``` {r, include = FALSE}
model2 <- dlm(m0 = 1000, C0 = 1000, FF = 1, V = 1470, GG = 1, W = 15100)
outputFilter2 <- dlmFilter(Nile, model2)
filterEstimates2 = window(outputFilter2$m, start=start(Nile)[1])
```

```{r, fig6, fig.cap = "Nile river data and filtering states estimates", out.width = '70%', fig.align = "center", echo = FALSE}
plot(Nile, y = NULL, plot.type = "multiple", ylab = "Nile annual flow", type = "o", cex = 0.3)
lines(filterEstimates2, col="green", type="o",lty=2, pch=4, cex = 0.3)
legend("bottomright",legend=c("data","filtered level"), col = c("black", "green"), lty=c(1,2), pch=c(1,4))
```

As expected, in model 2, with a higher signal-to-noise ratio, the filter estimates better tracks the actual observed data, as observed data are given more weight in the filtering step (Figure \ref{fig:fig6}).

``` {r, fig7, fig.cap = "Filetring states Standard Deviations", out.width = '70%', fig.align = "center", echo = FALSE}
n <- length(Nile)
Ct2 <- dlmSvd2var(outputFilter2$U.C, outputFilter2$D.C)
sqrtCt2 <- sqrt(unlist(Ct2))
sqrtCt_ts2 <- ts(sqrtCt2[-1], start = 1871, end = 1970, frequency = 1)
ts.plot(sqrtCt_ts2, xlab = "Time", ylab = "Standard deviation")
```

Also the standard deviation of the estimated model (Figure \ref{fig:fig7}) converges to a lower level (36.735) than before (63.5), indicating a better precision of the estimates (Figure \ref{fig:fig8}).


``` {r, fig8, fig.cap = "Nile data and filter estimates with credible intervals", out.width = '70%', fig.align = "center", echo = FALSE}
ci95_low2 <- outputFilter2$m + qnorm((1-0.95)/2) * sqrtCt2
ci95_up2 <- outputFilter2$m - qnorm((1-0.95)/2) * sqrtCt2
par(mar = c(4, 4, 4, 4) + 0.1, cex = 0.8)
plot(Nile, type = "o", cex = 0.3, col="black", ylab = "Nile annual flow")
lines(filterEstimates2, type="o",lty=2, pch=4, cex = 0.3, col="green")
lines(ci95_low2, lty = "longdash", col="blue")
lines(ci95_up2, lty = "longdash", col="blue")
legend("bottomright",legend=c("data","filtered level","95% c.i."),
     col=c("black", "green","blue"),lty=c(1,2,2),pch=c(1,4,20))
```

A higher signal-to-noise ratio determines a higher reliance of the last observation. Hence, the one-step ahead forecast in this case is close to be a one-step rightward shift of the observed data (Figure \ref{fig:fig9}). 
``` {r, fig9, fig.cap = "Nile river data and one-step ahead forecasts", out.width = '70%', fig.align = "center", echo = FALSE}
listR2 <- dlmSvd2var(outputFilter2$U.R, outputFilter2$D.R)
sqrtQ2 <- sqrt(unlist(listR2)+1470)
ci95_lowf2 <- outputFilter2$f + qnorm((1-0.95)/2)* sqrtQ2
ci95_upf2 <- outputFilter2$f - qnorm((1-0.95)/2) * sqrtQ2
par(mar = c(4, 4, 4, 4) + 0.1, cex = 0.8)
plot(window(Nile, start=start(Nile)), y = NULL, plot.type = "multiple", ylab = "Nile annual flow", type = "o", cex = 0.3)
lines(window(outputFilter2$f, start=start(Nile)), col = "green", type="o",lty=2, pch=4, cex = 0.3)
lines(ci95_lowf2, lty = "longdash", col="blue")
lines(ci95_upf2, lty = "longdash", col="blue")
legend("bottomright",legend=c("data","one-step ahead forecast", "95% c.i."), col = c("black", "green", "blue"), lty=c(1,2,2), pch=c(1,4,20))
```

